# Cloudflare R2 桶连接与公共访问说明（含当前配置）

## 当前配置数据

- R2 端点：`https://3b3767830899e284e2a631500cf8ef06.r2.cloudflarestorage.com/zhenyu-photo`
- 访问密钥（脱敏）：`ac0afe06e99b6f1************59e7e`
- 密钥（脱敏）：`b21a31cff5b25796******************a2fd`
- 桶名：`zhenyu-photo`
- 区域：`auto`
- 安全传输：`R2_SECURE=true`
- 公共域：`https://liu-zhen-yu.top`
- 公共名称：未设置（使用桶名）
- 公共 URL 是否包含桶路径段：`R2_PUBLIC_PATH_HAS_BUCKET=false`
- 证书校验跳过（仅本机测试）：`R2_SKIP_VERIFY=true`（生产建议关闭）

## 代码入口

- R2 客户端初始化：`python_server/main.py:51`
- 公共 URL 生成：`python_server/main.py:110`
- R2 公共 URL 反解析（删除/清理）：`python_server/main.py:148`
- 管理端配置接口：`python_server/main.py:374`（`POST /api/admin/r2-config`）
- 管理端上传接口：`python_server/main.py:857`（`POST /api/admin/r2-upload`）

## 后端环境变量（建议方式）

```
export R2_ENDPOINT="https://3b3767830899e284e2a631500cf8ef06.r2.cloudflarestorage.com/zhenyu-photo"
export R2_ACCESS_KEY="<请在部署环境设置为你的真实值>"
export R2_SECRET_KEY="<请在部署环境设置为你的真实值>"
export R2_BUCKET="zhenyu-photo"
export R2_SECURE="true"
export R2_REGION="auto"
export R2_PUBLIC_BASE="https://liu-zhen-yu.top"
export R2_PUBLIC_PATH_HAS_BUCKET="false"
export R2_SKIP_VERIFY="true"
```

> 说明：密钥已在本机测试过程中使用，但为避免泄露不写入仓库，请在正式环境通过环境变量/密钥托管注入真实值。

## 管理端接口配置（当前值）

```
POST /api/admin/r2-config
endpoint=https://3b3767830899e284e2a631500cf8ef06.r2.cloudflarestorage.com/zhenyu-photo
access_key=<使用环境变量注入，值与脱敏展示对应>
secret_key=<使用环境变量注入，值与脱敏展示对应>
secure=true
public_base=https://liu-zhen-yu.top
region=auto
skip_verify=true
public_path_has_bucket=false
```

## 上传结果样例（已验证）

- `image_url`：`https://liu-zhen-yu.top/processed/1763680449561-c536dc56.webp`
- `thumb_url`：`https://liu-zhen-yu.top/thumbs/1763680449561-c536dc56_thumb.webp`
- `carousel`：`https://liu-zhen-yu.top/carousel/1763681232968-ec94bb8e.webp`
- `carousel_thumbs`：`https://liu-zhen-yu.top/carousel_thumbs/1763681232968-ec94bb8e_thumb.webp`

## 公共 URL 生成规则

- 当 `R2_PUBLIC_BASE` 设置为自定义域时：
  - `R2_PUBLIC_PATH_HAS_BUCKET=false` → 公共 URL 形如：`<public_base>/<object_key>`（不含桶段）
  - 若设置了 `R2_PUBLIC_NAME` 且 `public_path_has_bucket=true`，可生成 `https://<public_base>/<public_name>/<object_key>`。
  - 典型对象 Key 前缀：`processed/`、`thumbs/`、`carousel/`、`carousel_thumbs/`、`videos/`

## 控制台设置与访问

- 在 R2 控制台为桶开启 “Public Access”。
- 如绑定了自定义域，请确保 DNS 与 R2 公共端正确指向，并同步在后端配置对应的 `public_base` 与路径规则，确保 URL 结构与实际映射一致。

## 重启与生效

- 修改 `.env.local` 后，需要重启后端以使配置生效。
- 运行后端：`python app.py`；前端开发：`npm run dev`

## 访问白名单建议（静态 uploads）

- 为避免误拦截本地静态资源，可在 `.env.local` 设置：
  - `ALLOWED_REFERRERS="http://localhost:5173, http://localhost:4002, https://liu-zhen-yu.top"`

## 常见问题

- 访问 404：确认对象 Key、确认是否需要桶名/公共名称路径段；或等待边缘传播 1–2 分钟。
- 本机 SSL 问题：测试可 `skip_verify=true`；生产安装根证书并设为 `false`。

## 安全提示

- 请勿在仓库中保存真实密钥；本文件中密钥已脱敏。密钥应通过环境变量或 Secrets 管理服务注入。
